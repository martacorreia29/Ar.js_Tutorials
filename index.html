<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GeoAR.js demo</title>
    <script src='https://aframe.io/releases/0.9.2/aframe.min.js'></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script>
        THREEx.ArToolkitContext.baseURL = 'https://raw.githack.com/jeromeetienne/ar.js/master/three.js/'
    </script>
    <script>
        window.onload = () => {
            const button = document.querySelector('button[data-action="change"]');
            button.innerText = '﹖';
            getLocation();
            let places = staticLoadPlaces();
            renderPlaces(places);
        };

        var lat = 0;
        var lng = 0;

        function staticLoadPlaces() {
            return [{
                name: 'Pokémon',
                location: {
                    lat: 38.999101,
                    lng: -9.007045,
                },
            }, ];
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(setLocation);
            }
        }

        function setLocation(position) {
            lat = position.coords.latitude;
            lng = position.coords.longitude;
        }

        var models = [{
            url: './assets/magnemite/scene.gltf',
            scale: '0.5 0.5 0.5',
            info: 'Magnemite, Lv. 5, HP 10/10',
            rotation: '0 180 0',
        }, {
            url: './assets/articuno/scene.gltf',
            scale: '0.2 0.2 0.2',
            rotation: '0 180 0',
            info: 'Articuno, Lv. 80, HP 100/100',
        }, {
            url: './assets/dragonite/scene.gltf',
            scale: '0.08 0.08 0.08',
            rotation: '0 180 0',
            info: 'Dragonite, Lv. 99, HP 150/150',
        }, ];

        var modelIndex = 0;
        var setModel = function(model, entity) {
            if (model.scale) {
                entity.setAttribute('scale', model.scale);
            }

            if (model.rotation) {
                entity.setAttribute('rotation', model.rotation);
            }

            if (model.position) {
                entity.setAttribute('position', model.position);
            }

            entity.setAttribute('gltf-model', model.url);

            const div = document.querySelector('.instructions');
            div.innerText = model.info;
        };

        function renderPlaces(places) {
            let scene = document.querySelector('a-scene');

            places.forEach((place) => {
                let latitude = place.location.lat;
                let longitude = place.location.lng;

                let model = document.createElement('a-entity');
                model.setAttribute('gps-entity-place', `latitude: ${latitude}; longitude: ${longitude};`);

                setModel(models[modelIndex], model);

                model.setAttribute('animation-mixer', '');

                document.querySelector('button[data-action="change"]').addEventListener('click', function() {
                    var entity = document.querySelector('[gps-entity-place]');
                    modelIndex++;
                    var newIndex = modelIndex % models.length;
                    setModel(models[newIndex], entity);
                });

                scene.appendChild(model);
            });
        }
    </script>
    <link rel="stylesheet" type="text/css" href="./style.css" />
</head>

<body style='margin: 0; overflow: hidden;'>
    <div class="centered instructions"></div>
    <a-scene vr-mode-ui='enabled: false' embedded arjs='sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;'>
        <a-camera gps-camera rotation-reader/>
    </a-scene>
    <div class="centered">
        <button data-action="change"></button>
    </div>
</body>